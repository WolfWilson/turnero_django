{% extends "operador/base_operator.html" %}
{% load static %}

{% block title %}Panel de Atenci√≥n - Operador{% endblock %}

{% block content %}
<!-- CONFIGURACI√ìN DEL √ÅREA (inyectada en JS) -->
<script>
  const AREA_CONFIG = JSON.parse('{{ config_json|escapejs }}');
  const CSRF_TOKEN = "{{ csrf_token }}";
</script>

<!-- TURNO EN LLAMADA / ATENCI√ìN --><div id="turno-actual-section">{% if turno_actual %}
<div class="turno-llamada-card">
  <div class="turno-llamada-header">
    <div class="turno-llamada-icon">
      <i class="fas fa-bell"></i>
    </div>
    <div class="turno-llamada-title">
      <h2>Turno en {{ turno_actual.estado.nombre }}</h2>
      <p class="turno-llamada-subtitle">
        {% if mesa %}Mesa: {{ mesa.nombre }}{% endif %}
        {% if turno_actual.ticket.prioridad > 0 %}
          <span class="badge-prioridad">
            <i class="fas fa-star"></i> Prioridad {{ turno_actual.ticket.prioridad }}
          </span>
        {% endif %}
      </p>
    </div>
  </div>
  
  <div class="turno-llamada-info">
    <div class="turno-info-item">
      <div class="turno-info-label">Persona</div>
      <div class="turno-info-value">
        <i class="fas fa-user"></i>
        {{ turno_actual.ticket.persona.apellido|upper }}, {{ turno_actual.ticket.persona.nombre|title }}
      </div>
    </div>
    
    <div class="turno-info-item">
      <div class="turno-info-label">DNI</div>
      <div class="turno-info-value">
        <i class="fas fa-id-card"></i>
        {{ turno_actual.ticket.persona.dni }}
      </div>
    </div>
    
    <div class="turno-info-item">
      <div class="turno-info-label">Tr√°mite</div>
      <div class="turno-info-value">
        <i class="fas fa-briefcase"></i>
        {{ turno_actual.tramite.nombre }}
      </div>
    </div>
    
    <div class="turno-info-item">
      <div class="turno-info-label">Hora</div>
      <div class="turno-info-value">
        <i class="fas fa-clock"></i>
        {{ turno_actual.fecha_hora_creacion|date:"H:i" }}
      </div>
    </div>
  </div>
  
  <div class="turno-llamada-acciones">
    <div class="turno-espera-badge">
      <div class="espera-numero">{{ total_espera }}</div>
      <div class="espera-label">En Espera</div>
    </div>
    
    {% if turno_actual.estado_id == 1 %}
    <!-- Estado: LLAMANDO -->
    <button class="btn-operador btn-operador-llamar" onclick="rellamarTurno({{ turno_actual.id }})">
      <i class="fas fa-bell"></i>
      <span>Re-llamar</span>
    </button>
    
    <button class="btn-operador btn-operador-iniciar" onclick="iniciarAtencion({{ turno_actual.id }})">
      <i class="fas fa-play"></i>
      <span>Iniciar Atenci√≥n</span>
    </button>
    
    <button class="btn-operador" onclick="noPresento({{ turno_actual.id }})" style="background: rgba(255, 152, 0, 0.95);">
      <i class="fas fa-user-slash"></i>
      <span>No se present√≥</span>
    </button>
    {% else %}
    <!-- Estado: EN_ATENCION -->
    <button class="btn-operador btn-operador-iniciar" onclick="finalizarAtencion({{ turno_actual.id }})" style="background: rgba(76, 175, 80, 0.95); grid-column: 2 / 4;">
      <i class="fas fa-check"></i>
      <span>Finalizar Atenci√≥n</span>
    </button>
    {% endif %}
    
    {% if config.permitir_derivaciones %}
    <button class="btn-operador" onclick="derivarTurno({{ turno_actual.id }})" style="background: rgba(156, 39, 176, 0.9);">
      <i class="fas fa-share"></i>
      <span>Derivar</span>
    </button>
    {% endif %}
    
    <button class="btn-operador btn-operador-proximo" onclick="proximoTurno()">
      <i class="fas fa-forward"></i>
      <span>Pr√≥ximo</span>
    </button>
  </div>
</div>
{% else %}
<!-- NO HAY TURNO ACTIVO -->
<div class="turno-llamada-card" style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.95) 0%, rgba(25, 118, 210, 0.9) 100%);">
  <div class="turno-llamada-header">
    <div class="turno-llamada-icon">
      <i class="fas fa-coffee"></i>
    </div>
    <div class="turno-llamada-title">
      <h2>Sin turno asignado</h2>
      <p class="turno-llamada-subtitle">
        {% if mesa %}Mesa: {{ mesa.nombre }} | {% endif %}
        {% if horario_atencion.permitido %}Listo para atender{% else %}{{ horario_atencion.mensaje }}{% endif %}
      </p>
    </div>
  </div>
  
  <div class="turno-llamada-acciones" style="grid-template-columns: auto 1fr;">
    <div class="turno-espera-badge">
      <div class="espera-numero">{{ total_espera }}</div>
      <div class="espera-label">En Espera</div>
    </div>
    
    {% if total_espera > 0 and horario_atencion.permitido %}
    <button class="btn-operador btn-operador-proximo" onclick="proximoTurno()" style="padding: var(--space-lg);">
      <i class="fas fa-play-circle" style="font-size: 2rem;"></i>
      <span style="font-size: 1.125rem;">Llamar Pr√≥ximo Turno</span>
    </button>
    {% else %}
    <div style="text-align: center; padding: var(--space-lg); color: rgba(255, 255, 255, 0.8);">
      <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: var(--space-sm);"></i>
      <p style="margin: 0; font-size: 1.125rem;">
        {% if not horario_atencion.permitido %}{{ horario_atencion.mensaje }}{% else %}No hay turnos pendientes{% endif %}
      </p>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}
</div>

<!-- LISTA DE TURNOS EN ESPERA -->
<div id="turnos-pendientes" class="turnos-espera-section">
  <div class="turnos-espera-header">
    <h2 class="turnos-espera-title">
      <i class="fas fa-list"></i>
      Turnos en Espera {% if area %} ‚Äî {{ area.nombre }}{% endif %}
    </h2>
    <span class="turnos-espera-count">{{ turnos_pendientes|length }} turnos</span>
  </div>
  
  {% if turnos_pendientes %}
  <table class="turnos-table">
    <thead>
      <tr>
        <th>N¬∞</th>
        <th>Nombre</th>
        <th>DNI</th>
        <th>Tr√°mite</th>
        <th>Prior.</th>
        <th>Hora</th>
      </tr>
    </thead>
    <tbody>
      {% for turno in turnos_pendientes %}
      <tr onclick="seleccionarTurno({{ turno.id }})" {% if turno.ticket.prioridad > 0 %}class="turno-prioritario"{% endif %}>
        <td class="turno-numero-cell">{{ turno.numero_visible|stringformat:"03d" }}</td>
        <td class="turno-nombre-cell">
          {{ turno.ticket.persona.apellido|upper }}, {{ turno.ticket.persona.nombre|title }}
        </td>
        <td class="turno-dni-cell">{{ turno.ticket.persona.dni }}</td>
        <td class="turno-tramite-cell">{{ turno.tramite.nombre }}</td>
        <td class="turno-prioridad-cell">
          {% if turno.ticket.prioridad > 0 %}
            <span class="badge-prioridad-table" title="Prioridad {{ turno.ticket.prioridad }}">
              <i class="fas fa-star"></i> {{ turno.ticket.prioridad }}
            </span>
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        <td class="turno-hora-cell">{{ turno.fecha_hora_creacion|date:"H:i" }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="turnos-empty-state">
    <i class="fas fa-inbox"></i>
    <h3>No hay turnos en espera</h3>
    <p>Todos los turnos han sido atendidos</p>
  </div>
  {% endif %}
</div>

<!-- MODAL: Motivo de finalizaci√≥n -->
<div id="modal-motivo" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <h3><i class="fas fa-clipboard-check"></i> Finalizar Atenci√≥n</h3>
    <p>{{ config.requiere_motivo_fin|yesno:"Ingrese el motivo de la atenci√≥n (requerido):,Motivo de la atenci√≥n (opcional):" }}</p>
    <textarea id="motivo-texto" rows="3" placeholder="Describa brevemente el motivo..." style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #ddd; font-family:inherit; font-size:0.95rem;"></textarea>
    <div style="display:flex; gap:1rem; margin-top:1rem; justify-content:flex-end;">
      <button onclick="cerrarModal()" style="padding:0.5rem 1.5rem; border:1px solid #ccc; border-radius:8px; background:#fff; cursor:pointer;">Cancelar</button>
      <button id="btn-confirmar-fin" onclick="confirmarFinalizacion()" style="padding:0.5rem 1.5rem; border:none; border-radius:8px; background:#4CAF50; color:#fff; cursor:pointer; font-weight:600;">Confirmar</button>
    </div>
  </div>
</div>

<style>
  .modal-overlay {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.5); z-index: 1000;
    display: flex; align-items: center; justify-content: center;
  }
  .modal-content {
    background: #fff; border-radius: 16px; padding: 2rem;
    max-width: 500px; width: 90%; box-shadow: 0 16px 48px rgba(0,0,0,0.2);
  }
  .modal-content h3 { margin: 0 0 0.75rem; color: #1a2332; }
  .modal-content p { color: #666; margin-bottom: 1rem; }
  .badge-prioridad {
    display: inline-block; background: rgba(255,215,0,0.3); color: #f9a825;
    padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; margin-left: 0.5rem;
  }
  .turno-prioritario { background: rgba(255, 215, 0, 0.08) !important; }
  .badge-prioridad-table {
    display: inline-flex; align-items: center; gap: 3px;
    background: rgba(255, 152, 0, 0.15); color: #e65100;
    padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: 600;
  }
  .turno-prioridad-cell { text-align: center; }
</style>

<script>
// =====================================================================
//  ACCIONES DEL OPERADOR ‚Äî Conectadas al backend via API
// =====================================================================
let turnoFinalizandoId = null;

async function apiFetch(url, body = {}) {
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
    body: JSON.stringify(body),
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Error del servidor');
  return data;
}

// ‚îÄ‚îÄ Re-llamar turno (volver a mostrar alerta en monitor) ‚îÄ‚îÄ
function rellamarTurno(turnoId) {
  // El turno ya est√° en LLAMANDO ‚Äî el monitor lo mostrar√° en el pr√≥ximo polling
  // Aqu√≠ podr√≠amos enviar se√±al WebSocket en el futuro
  const msg = AREA_CONFIG.sonido_llamada
    ? 'üîî Llamada re-enviada al monitor (sonido habilitado)'
    : 'üîî Llamada re-enviada al monitor';
  showToast(msg, 'info');
}

// ‚îÄ‚îÄ Iniciar atenci√≥n ‚îÄ‚îÄ
async function iniciarAtencion(turnoId) {
  try {
    const data = await apiFetch(`/atencion/api/iniciar/${turnoId}/`);
    showToast(`‚úÖ Atenci√≥n iniciada ‚Äî ${data.hora_inicio}`, 'success');
    setTimeout(() => location.reload(), 800);
  } catch (e) {
    showToast(`‚ùå ${e.message}`, 'error');
  }
}

// ‚îÄ‚îÄ Finalizar atenci√≥n (con modal si requiere motivo) ‚îÄ‚îÄ
function finalizarAtencion(turnoId) {
  turnoFinalizandoId = turnoId;
  if (AREA_CONFIG.requiere_motivo_fin) {
    document.getElementById('modal-motivo').style.display = 'flex';
    document.getElementById('motivo-texto').focus();
  } else {
    // Mostrar modal igual pero como opcional
    document.getElementById('modal-motivo').style.display = 'flex';
  }
}

async function confirmarFinalizacion() {
  const motivo = document.getElementById('motivo-texto').value.trim();
  if (AREA_CONFIG.requiere_motivo_fin && !motivo) {
    showToast('‚ö†Ô∏è Debe ingresar un motivo para finalizar', 'warning');
    return;
  }
  try {
    await apiFetch(`/atencion/api/finalizar/${turnoFinalizandoId}/`, { motivo });
    cerrarModal();
    showToast('‚úÖ Atenci√≥n finalizada correctamente', 'success');
    setTimeout(() => location.reload(), 800);
  } catch (e) {
    showToast(`‚ùå ${e.message}`, 'error');
  }
}

function cerrarModal() {
  document.getElementById('modal-motivo').style.display = 'none';
  document.getElementById('motivo-texto').value = '';
  turnoFinalizandoId = null;
}

// ‚îÄ‚îÄ No se present√≥ ‚îÄ‚îÄ
async function noPresento(turnoId) {
  if (!confirm('¬øMarcar como "No se present√≥"?')) return;
  try {
    await apiFetch(`/atencion/api/no-presento/${turnoId}/`);
    showToast('‚ö†Ô∏è Turno marcado como no presentado', 'warning');
    setTimeout(() => location.reload(), 800);
  } catch (e) {
    showToast(`‚ùå ${e.message}`, 'error');
  }
}

// ‚îÄ‚îÄ Pr√≥ximo turno ‚îÄ‚îÄ
async function proximoTurno() {
  try {
    const data = await apiFetch('/atencion/api/proximo/');
    let msg = `üîî Llamando a ${data.persona} ‚Äî Turno #${data.numero_visible}`;
    if (data.prioridad > 0) msg += ' ‚≠ê (prioritario)';
    showToast(msg, 'success');
    setTimeout(() => location.reload(), 1200);
  } catch (e) {
    showToast(`‚ÑπÔ∏è ${e.message}`, 'info');
  }
}

// ‚îÄ‚îÄ Derivar turno ‚îÄ‚îÄ
async function derivarTurno(turnoId) {
  const destino = prompt('ID del operador destino:');
  if (!destino) return;
  const motivo = prompt('Motivo de la derivaci√≥n (opcional):');
  try {
    const data = await apiFetch(`/atencion/api/derivar/${turnoId}/`, {
      operador_destino_id: parseInt(destino),
      motivo: motivo || '',
    });
    showToast(`‚Ü™Ô∏è Turno derivado a ${data.derivado_a}`, 'success');
    setTimeout(() => location.reload(), 800);
  } catch (e) {
    showToast(`‚ùå ${e.message}`, 'error');
  }
}

// ‚îÄ‚îÄ Seleccionar turno de la lista ‚îÄ‚îÄ
async function seleccionarTurno(turnoId) {
  if (!confirm('¬øLlamar a este turno?')) return;
  try {
    const data = await apiFetch(`/atencion/api/llamar/${turnoId}/`);
    showToast(`üîî Llamando a ${data.persona} ‚Äî ${data.mesa}`, 'success');
    setTimeout(() => location.reload(), 1000);
  } catch (e) {
    showToast(`‚ùå ${e.message}`, 'error');
  }
}

// ‚îÄ‚îÄ Toast de notificaci√≥n ‚îÄ‚îÄ
function showToast(message, type = 'info') {
  const colors = {
    success: '#4CAF50', error: '#f44336', warning: '#FF9800', info: '#2196F3'
  };
  const toast = document.createElement('div');
  toast.style.cssText = `
    position:fixed; top:1.5rem; right:1.5rem; z-index:9999;
    padding:1rem 1.5rem; border-radius:12px; color:#fff;
    background:${colors[type]}; font-weight:500;
    box-shadow:0 4px 16px rgba(0,0,0,0.2); max-width:400px;
    animation: slideIn 0.3s ease-out;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s';
    setTimeout(() => toast.remove(), 300);
  }, 3500);
}

// ‚îÄ‚îÄ Auto-actualizaci√≥n sin parpadeo ‚îÄ‚îÄ
let refreshInterval = null;

async function actualizarPanel() {
  try {
    const response = await fetch(window.location.href, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    const html = await response.text();
    const parser = new DOMParser();
    const newDoc = parser.parseFromString(html, 'text/html');
    
    // Actualizar secciones solo si hay cambios
    actualizarSiDifiere('turno-actual-section', newDoc);
    actualizarSiDifiere('turnos-pendientes', newDoc);
  } catch (e) {
    console.error('Error actualizando panel:', e);
  }
}

function actualizarSiDifiere(sectionId, newDoc) {
  const current = document.getElementById(sectionId);
  const nuevo = newDoc.getElementById(sectionId);
  
  if (!current || !nuevo) return;
  
  // Solo actualizar si el contenido cambi√≥
  if (current.innerHTML.trim() !== nuevo.innerHTML.trim()) {
    current.style.transition = 'opacity 0.2s';
    current.style.opacity = '0.7';
    setTimeout(() => {
      current.innerHTML = nuevo.innerHTML;
      current.style.opacity = '1';
    }, 100);
  }
}

// Iniciar polling inteligente
refreshInterval = setInterval(actualizarPanel, 5000);

// Pausar polling cuando la pesta√±a est√° oculta (optimizaci√≥n)
if (document.hidden !== undefined) {
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      clearInterval(refreshInterval);
    } else {
      refreshInterval = setInterval(actualizarPanel, 5000);
      actualizarPanel(); // Actualizar inmediatamente al volver
    }
  });
}
</script>

<style>
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
</style>
{% endblock %}
