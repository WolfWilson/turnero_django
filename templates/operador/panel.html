{% extends "operador/base_operator.html" %}
{% load static %}

{% block title %}Panel de Atención - Operador{% endblock %}

{% block content %}
<!-- CONFIGURACIÓN DEL ÁREA (inyectada en JS) -->
<script>
  const AREA_CONFIG = JSON.parse('{{ config_json|escapejs }}');
  const CSRF_TOKEN = "{{ csrf_token }}";
</script>

<!-- TURNO EN LLAMADA / ATENCIÓN --><div id="turno-actual-section">{% if turno_actual %}
<div class="turno-llamada-card">
  <div class="turno-llamada-header">
    <div class="turno-llamada-icon">
      <i class="fas fa-bell"></i>
    </div>
    <div class="turno-llamada-title">
      <h2>Turno en {{ turno_actual.estado.nombre }}</h2>
      <p class="turno-llamada-subtitle">
        {% if mesa %}Mesa: {{ mesa.nombre }}{% endif %}
        {% if turno_actual.ticket.prioridad > 0 %}
          <span class="badge-prioridad">
            <i class="fas fa-star"></i> Prioridad {{ turno_actual.ticket.prioridad }}
          </span>
        {% endif %}
      </p>
    </div>
  </div>
  
  <div class="turno-llamada-info">
    <div class="turno-info-item">
      <div class="turno-info-label">Persona</div>
      <div class="turno-info-value">
        <i class="fas fa-user"></i>
        {{ turno_actual.ticket.persona.apellido|upper }}, {{ turno_actual.ticket.persona.nombre|title }}
      </div>
    </div>
    
    <div class="turno-info-item">
      <div class="turno-info-label">DNI</div>
      <div class="turno-info-value">
        <i class="fas fa-id-card"></i>
        {{ turno_actual.ticket.persona.dni }}
      </div>
    </div>
    
    <div class="turno-info-item">
      <div class="turno-info-label">Trámite</div>
      <div class="turno-info-value">
        <i class="fas fa-briefcase"></i>
        {{ turno_actual.tramite.nombre }}
      </div>
    </div>
    
    <div class="turno-info-item">
      <div class="turno-info-label">Hora</div>
      <div class="turno-info-value">
        <i class="fas fa-clock"></i>
        {{ turno_actual.fecha_hora_creacion|date:"H:i" }}
      </div>
    </div>
  </div>
  
  <div class="turno-llamada-acciones">
    <div class="turno-espera-badge">
      <div class="espera-numero">{{ total_espera }}</div>
      <div class="espera-label">En Espera</div>
    </div>
    
    {% if turno_actual.estado_id == 1 %}
    <!-- Estado: LLAMANDO -->
    <button class="btn-operador btn-operador-llamar" onclick="rellamarTurno({{ turno_actual.id }})">
      <i class="fas fa-bell"></i>
      <span>Re-llamar</span>
    </button>
    
    <button class="btn-operador btn-operador-iniciar" onclick="iniciarAtencion({{ turno_actual.id }})">
      <i class="fas fa-play"></i>
      <span>Iniciar Atención</span>
    </button>
    
    <button class="btn-operador" onclick="noPresento({{ turno_actual.id }})" style="background: rgba(255, 152, 0, 0.95);">
      <i class="fas fa-user-slash"></i>
      <span>No se presentó</span>
    </button>
    {% else %}
    <!-- Estado: EN_ATENCION -->
    <button class="btn-operador btn-operador-iniciar" onclick="finalizarAtencion({{ turno_actual.id }})" style="background: rgba(76, 175, 80, 0.95); grid-column: 2 / 4;">
      <i class="fas fa-check"></i>
      <span>Finalizar Atención</span>
    </button>
    {% endif %}
    
    {% if config.permitir_derivaciones %}
    <button class="btn-operador" onclick="derivarTurno({{ turno_actual.id }})" style="background: rgba(156, 39, 176, 0.9);">
      <i class="fas fa-share"></i>
      <span>Derivar</span>
    </button>
    {% endif %}
    
    <button class="btn-operador btn-operador-proximo" onclick="proximoTurno()">
      <i class="fas fa-forward"></i>
      <span>Próximo</span>
    </button>
  </div>
</div>
{% else %}
<!-- NO HAY TURNO ACTIVO -->
<div class="turno-llamada-card" style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.95) 0%, rgba(25, 118, 210, 0.9) 100%);">
  <div class="turno-llamada-header">
    <div class="turno-llamada-icon">
      <i class="fas fa-coffee"></i>
    </div>
    <div class="turno-llamada-title">
      <h2>Sin turno asignado</h2>
      <p class="turno-llamada-subtitle">
        {% if mesa %}Mesa: {{ mesa.nombre }} | {% endif %}
        {% if horario_atencion.permitido %}Listo para atender{% else %}{{ horario_atencion.mensaje }}{% endif %}
      </p>
    </div>
  </div>
  
  <div class="turno-llamada-acciones" style="grid-template-columns: auto 1fr;">
    <div class="turno-espera-badge">
      <div class="espera-numero">{{ total_espera }}</div>
      <div class="espera-label">En Espera</div>
    </div>
    
    {% if total_espera > 0 and horario_atencion.permitido %}
    <button class="btn-operador btn-operador-proximo" onclick="proximoTurno()" style="padding: var(--space-lg);">
      <i class="fas fa-play-circle" style="font-size: 2rem;"></i>
      <span style="font-size: 1.125rem;">Llamar Próximo Turno</span>
    </button>
    {% else %}
    <div style="text-align: center; padding: var(--space-lg); color: rgba(255, 255, 255, 0.8);">
      <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: var(--space-sm);"></i>
      <p style="margin: 0; font-size: 1.125rem;">
        {% if not horario_atencion.permitido %}{{ horario_atencion.mensaje }}{% else %}No hay turnos pendientes{% endif %}
      </p>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}
</div>

<!-- LISTA DE TURNOS EN ESPERA -->
<div id="turnos-pendientes" class="turnos-espera-section">
  <div class="turnos-espera-header">
    <h2 class="turnos-espera-title">
      <i class="fas fa-list"></i>
      Turnos en Espera {% if area %} — {{ area.nombre }}{% endif %}
    </h2>
    <span class="turnos-espera-count">{{ turnos_pendientes|length }} turnos</span>
  </div>
  
  {% if turnos_pendientes %}
  <table class="turnos-table">
    <thead>
      <tr>
        <th>N°</th>
        <th>Nombre</th>
        <th>DNI</th>
        <th>Trámite</th>
        <th>Prior.</th>
        <th>Hora</th>
      </tr>
    </thead>
    <tbody>
      {% for turno in turnos_pendientes %}
      <tr onclick="seleccionarTurno({{ turno.id }})" {% if turno.ticket.prioridad > 0 %}class="turno-prioritario"{% endif %}>
        <td class="turno-numero-cell">{{ turno.numero_visible|stringformat:"03d" }}</td>
        <td class="turno-nombre-cell">
          {{ turno.ticket.persona.apellido|upper }}, {{ turno.ticket.persona.nombre|title }}
        </td>
        <td class="turno-dni-cell">{{ turno.ticket.persona.dni }}</td>
        <td class="turno-tramite-cell">{{ turno.tramite.nombre }}</td>
        <td class="turno-prioridad-cell">
          {% if turno.ticket.prioridad > 0 %}
            <span class="badge-prioridad-table" title="Prioridad {{ turno.ticket.prioridad }}">
              <i class="fas fa-star"></i> {{ turno.ticket.prioridad }}
            </span>
          {% else %}
            —
          {% endif %}
        </td>
        <td class="turno-hora-cell">{{ turno.fecha_hora_creacion|date:"H:i" }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="turnos-empty-state">
    <i class="fas fa-inbox"></i>
    <h3>No hay turnos en espera</h3>
    <p>Todos los turnos han sido atendidos</p>
  </div>
  {% endif %}
</div>

<!-- MODAL: Motivo de finalización -->
<div id="modal-motivo" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-icon modal-icon-success"><i class="fas fa-clipboard-check"></i></div>
      <h3>Finalizar Atención</h3>
    </div>
    <p class="modal-desc">{{ config.requiere_motivo_fin|yesno:"Ingrese el motivo de la atención (requerido):,Motivo de la atención (opcional):" }}</p>
    <textarea id="motivo-texto" rows="3" class="modal-input" placeholder="Describa brevemente el motivo..."></textarea>
    <div class="modal-actions">
      <button onclick="cerrarModal('modal-motivo')" class="modal-btn modal-btn-cancel">Cancelar</button>
      <button onclick="confirmarFinalizacion()" class="modal-btn modal-btn-confirm"><i class="fas fa-check"></i> Confirmar</button>
    </div>
  </div>
</div>

<!-- MODAL: Confirmar acción genérica -->
<div id="modal-confirmar" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-icon" id="confirm-modal-icon"><i class="fas fa-question-circle"></i></div>
      <h3 id="confirm-modal-titulo">Confirmar</h3>
    </div>
    <p class="modal-desc" id="confirm-modal-mensaje"></p>
    <div class="modal-actions">
      <button onclick="resolverConfirm(false)" class="modal-btn modal-btn-cancel">Cancelar</button>
      <button onclick="resolverConfirm(true)" class="modal-btn modal-btn-confirm" id="confirm-modal-btn">Confirmar</button>
    </div>
  </div>
</div>

<!-- MODAL: Derivar turno -->
<div id="modal-derivar" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-icon modal-icon-derivar"><i class="fas fa-share"></i></div>
      <h3>Derivar Turno</h3>
    </div>
    <p class="modal-desc">Ingrese el ID del operador destino y un motivo opcional.</p>
    <label class="modal-label">Operador destino (ID) <span style="color:#f44336;">*</span></label>
    <input type="number" id="derivar-destino" class="modal-input" placeholder="Ej: 2" min="1">
    <label class="modal-label" style="margin-top:0.75rem;">Motivo (opcional)</label>
    <textarea id="derivar-motivo" rows="2" class="modal-input" placeholder="Motivo de la derivación..."></textarea>
    <div class="modal-actions">
      <button onclick="cerrarModal('modal-derivar')" class="modal-btn modal-btn-cancel">Cancelar</button>
      <button onclick="confirmarDerivacion()" class="modal-btn modal-btn-confirm" style="background:rgba(156,39,176,0.95);"><i class="fas fa-share"></i> Derivar</button>
    </div>
  </div>
</div>

<style>
  /* ═══ Modal System ═══ */
  .modal-overlay {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.45); backdrop-filter: blur(4px);
    z-index: 1000;
    display: flex; align-items: center; justify-content: center;
    animation: modalBgIn 0.25s ease-out;
  }
  @keyframes modalBgIn { from { opacity:0; } to { opacity:1; } }
  .modal-content {
    background: #fff; border-radius: 20px; padding: 2rem;
    max-width: 460px; width: 92%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.1);
    animation: modalSlideIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
  }
  @keyframes modalSlideIn {
    from { transform: translateY(30px) scale(0.95); opacity:0; }
    to   { transform: translateY(0) scale(1); opacity:1; }
  }
  .modal-header {
    display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;
  }
  .modal-header h3 { margin:0; color:#1a2332; font-size:1.2rem; }
  .modal-icon {
    width: 44px; height: 44px; border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem; flex-shrink: 0;
    background: rgba(33,150,243,0.12); color: #2196f3;
  }
  .modal-icon-success { background: rgba(76,175,80,0.12); color: #4caf50; }
  .modal-icon-warning { background: rgba(255,152,0,0.12); color: #ff9800; }
  .modal-icon-danger  { background: rgba(244,67,54,0.12); color: #f44336; }
  .modal-icon-derivar { background: rgba(156,39,176,0.12); color: #9c27b0; }
  .modal-desc { color:#666; margin-bottom:1rem; font-size:0.95rem; line-height:1.5; }
  .modal-label { display:block; font-size:0.85rem; font-weight:600; color:#555; margin-bottom:0.35rem; }
  .modal-input {
    width:100%; padding:0.75rem 1rem; border-radius:12px;
    border:1.5px solid #e0e0e0; font-family:inherit; font-size:0.95rem;
    transition: border-color 0.2s, box-shadow 0.2s; outline:none;
    background: #fafafa;
  }
  .modal-input:focus {
    border-color: #2196f3; box-shadow: 0 0 0 3px rgba(33,150,243,0.12);
    background: #fff;
  }
  .modal-actions {
    display:flex; gap:0.75rem; margin-top:1.25rem; justify-content:flex-end;
  }
  .modal-btn {
    padding:0.6rem 1.5rem; border-radius:12px; font-size:0.9rem;
    font-weight:600; cursor:pointer; transition: all 0.2s;
    font-family: inherit; border: none;
  }
  .modal-btn-cancel {
    background:#f5f5f5; color:#666; border:1px solid #e0e0e0;
  }
  .modal-btn-cancel:hover { background:#eee; }
  .modal-btn-confirm {
    background:rgba(76,175,80,0.95); color:#fff;
    box-shadow: 0 2px 8px rgba(76,175,80,0.3);
  }
  .modal-btn-confirm:hover {
    transform: translateY(-1px); box-shadow: 0 4px 12px rgba(76,175,80,0.4);
  }

  /* ═══ Toast Push Notifications (Stacked / Accordion) ═══ */
  #toast-container {
    position: fixed; top: 1.25rem; right: 1.25rem; z-index: 9999;
    display: flex; flex-direction: column; gap: 0.5rem;
    pointer-events: none; max-width: 420px; width: calc(100% - 2.5rem);
  }
  .toast-notification {
    display: flex; align-items: flex-start; gap: 0.85rem;
    padding: 1rem 1.25rem;
    border-radius: 16px; color: #fff;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18), 0 2px 8px rgba(0,0,0,0.1);
    pointer-events: auto;
    animation: toastSlideIn 0.4s cubic-bezier(0.34,1.56,0.64,1);
    backdrop-filter: blur(12px);
    cursor: pointer;
    transition: transform 0.2s, opacity 0.3s;
    position: relative;
    overflow: hidden;
  }
  .toast-notification:hover { transform: translateX(-4px); }
  .toast-notification.toast-removing {
    animation: toastSlideOut 0.35s ease-in forwards;
  }
  @keyframes toastSlideIn {
    from { transform: translateX(100%) scale(0.8); opacity:0; }
    to   { transform: translateX(0) scale(1); opacity:1; }
  }
  @keyframes toastSlideOut {
    from { transform: translateX(0); opacity:1; max-height:120px; margin-bottom:0; }
    to   { transform: translateX(110%); opacity:0; max-height:0; margin-bottom:-0.5rem; padding:0 1.25rem; }
  }
  .toast-icon {
    width: 36px; height: 36px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem; flex-shrink: 0;
    background: rgba(255,255,255,0.2);
  }
  .toast-body { flex:1; min-width:0; }
  .toast-title {
    font-weight: 700; font-size: 0.85rem; margin-bottom: 0.15rem;
    text-transform: uppercase; letter-spacing: 0.3px;
    opacity: 0.9;
  }
  .toast-message { font-size: 0.92rem; font-weight: 500; line-height: 1.4; }
  .toast-progress {
    position: absolute; bottom:0; left:0; height:3px;
    border-radius: 0 0 16px 16px;
    background: rgba(255,255,255,0.4);
    animation: toastProgress var(--toast-duration, 4s) linear forwards;
  }
  @keyframes toastProgress { from { width:100%; } to { width:0%; } }

  .toast-success { background: linear-gradient(135deg, #43a047, #2e7d32); }
  .toast-error   { background: linear-gradient(135deg, #e53935, #c62828); }
  .toast-warning { background: linear-gradient(135deg, #fb8c00, #e65100); }
  .toast-info    { background: linear-gradient(135deg, #1e88e5, #1565c0); }

  /* ═══ Badges y prioridad ═══ */
  .badge-prioridad {
    display: inline-block; background: rgba(255,215,0,0.3); color: #f9a825;
    padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; margin-left: 0.5rem;
  }
  .turno-prioritario { background: rgba(255, 215, 0, 0.08) !important; }
  .badge-prioridad-table {
    display: inline-flex; align-items: center; gap: 3px;
    background: rgba(255, 152, 0, 0.15); color: #e65100;
    padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: 600;
  }
  .turno-prioridad-cell { text-align: center; }
</style>

<!-- Toast container (stacked accordion) -->
<div id="toast-container"></div>

<script>
// =====================================================================
//  SISTEMA DE NOTIFICACIONES PUSH (Stacked / Accordion)
// =====================================================================
const TOAST_ICONS = {
  success: 'fa-check',
  error:   'fa-times',
  warning: 'fa-exclamation',
  info:    'fa-info'
};
const TOAST_TITLES = {
  success: 'Éxito',
  error:   'Error',
  warning: 'Advertencia',
  info:    'Información'
};
const MAX_TOASTS = 5;

function showToast(message, type = 'info', duration = 4000) {
  const container = document.getElementById('toast-container');
  
  // Limitar la cantidad de toasts visibles (acordeón)
  const toasts = container.querySelectorAll('.toast-notification:not(.toast-removing)');
  if (toasts.length >= MAX_TOASTS) {
    dismissToast(toasts[0]);
  }

  const toast = document.createElement('div');
  toast.className = `toast-notification toast-${type}`;
  toast.style.setProperty('--toast-duration', `${duration}ms`);
  toast.innerHTML = `
    <div class="toast-icon"><i class="fas ${TOAST_ICONS[type]}"></i></div>
    <div class="toast-body">
      <div class="toast-title">${TOAST_TITLES[type]}</div>
      <div class="toast-message">${message}</div>
    </div>
    <div class="toast-progress"></div>
  `;
  toast.onclick = () => dismissToast(toast);
  container.appendChild(toast);

  // Auto-dismiss
  setTimeout(() => dismissToast(toast), duration);
}

function dismissToast(toast) {
  if (!toast || toast.classList.contains('toast-removing')) return;
  toast.classList.add('toast-removing');
  toast.addEventListener('animationend', () => toast.remove(), { once: true });
}

// =====================================================================
//  MODAL CONFIRM / PROMPT (reemplazo de alert/confirm/prompt nativos)
// =====================================================================
let confirmResolver = null;

function customConfirm(titulo, mensaje, { icon = 'fa-question-circle', iconClass = '', btnText = 'Confirmar', btnColor = '' } = {}) {
  return new Promise(resolve => {
    confirmResolver = resolve;
    const modal = document.getElementById('modal-confirmar');
    const iconEl = document.getElementById('confirm-modal-icon');
    document.getElementById('confirm-modal-titulo').textContent = titulo;
    document.getElementById('confirm-modal-mensaje').textContent = mensaje;
    iconEl.innerHTML = `<i class="fas ${icon}"></i>`;
    iconEl.className = `modal-icon ${iconClass}`;
    const btn = document.getElementById('confirm-modal-btn');
    btn.textContent = btnText;
    if (btnColor) btn.style.background = btnColor;
    else btn.style.background = '';
    modal.style.display = 'flex';
  });
}

function resolverConfirm(value) {
  document.getElementById('modal-confirmar').style.display = 'none';
  if (confirmResolver) { confirmResolver(value); confirmResolver = null; }
}

function cerrarModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
  if (modalId === 'modal-motivo') {
    document.getElementById('motivo-texto').value = '';
    turnoFinalizandoId = null;
  }
  if (modalId === 'modal-derivar') {
    document.getElementById('derivar-destino').value = '';
    document.getElementById('derivar-motivo').value = '';
    turnoDerivandoId = null;
  }
}

// Cerrar modales con Escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay').forEach(m => {
      if (m.style.display !== 'none') {
        m.style.display = 'none';
        if (confirmResolver) { confirmResolver(false); confirmResolver = null; }
      }
    });
  }
});
// Cerrar modales al hacer clic fuera
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => {
    if (e.target === m) {
      m.style.display = 'none';
      if (confirmResolver) { confirmResolver(false); confirmResolver = null; }
    }
  });
});

// =====================================================================
//  ACCIONES DEL OPERADOR — Conectadas al backend via API
// =====================================================================
let turnoFinalizandoId = null;
let turnoDerivandoId = null;

async function apiFetch(url, body = {}) {
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
    body: JSON.stringify(body),
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Error del servidor');
  return data;
}

// ── Re-llamar turno ──
function rellamarTurno(turnoId) {
  const msg = AREA_CONFIG.sonido_llamada
    ? 'Llamada re-enviada al monitor (sonido habilitado)'
    : 'Llamada re-enviada al monitor';
  showToast(msg, 'info');
}

// ── Iniciar atención ──
async function iniciarAtencion(turnoId) {
  try {
    const data = await apiFetch(`/atencion/api/iniciar/${turnoId}/`);
    showToast(`Atención iniciada — ${data.hora_inicio}`, 'success');
    setTimeout(() => actualizarPanel(), 800);
  } catch (e) {
    showToast(e.message, 'error');
  }
}

// ── Finalizar atención (con modal) ──
function finalizarAtencion(turnoId) {
  turnoFinalizandoId = turnoId;
  document.getElementById('modal-motivo').style.display = 'flex';
  setTimeout(() => document.getElementById('motivo-texto').focus(), 150);
}

async function confirmarFinalizacion() {
  const motivo = document.getElementById('motivo-texto').value.trim();
  if (AREA_CONFIG.requiere_motivo_fin && !motivo) {
    showToast('Debe ingresar un motivo para finalizar', 'warning');
    return;
  }
  try {
    await apiFetch(`/atencion/api/finalizar/${turnoFinalizandoId}/`, { motivo });
    cerrarModal('modal-motivo');
    showToast('Atención finalizada correctamente', 'success');
    setTimeout(() => actualizarPanel(), 800);
  } catch (e) {
    showToast(e.message, 'error');
  }
}

// ── No se presentó ──
async function noPresento(turnoId) {
  const ok = await customConfirm(
    'No se presentó',
    '¿Marcar este turno como "No se presentó"?',
    { icon: 'fa-user-slash', iconClass: 'modal-icon-warning', btnText: 'Sí, marcar', btnColor: 'rgba(255,152,0,0.95)' }
  );
  if (!ok) return;
  try {
    await apiFetch(`/atencion/api/no-presento/${turnoId}/`);
    showToast('Turno marcado como no presentado', 'warning');
    setTimeout(() => actualizarPanel(), 800);
  } catch (e) {
    showToast(e.message, 'error');
  }
}

// ── Próximo turno ──
async function proximoTurno() {
  try {
    const data = await apiFetch('/atencion/api/proximo/');
    let msg = `Llamando a ${data.persona} — Turno #${data.numero_visible}`;
    if (data.prioridad > 0) msg += ' ⭐ (prioritario)';
    showToast(msg, 'success', 5000);
    setTimeout(() => actualizarPanel(), 1200);
  } catch (e) {
    showToast(e.message, 'info');
  }
}

// ── Derivar turno (con modal) ──
function derivarTurno(turnoId) {
  turnoDerivandoId = turnoId;
  document.getElementById('modal-derivar').style.display = 'flex';
  setTimeout(() => document.getElementById('derivar-destino').focus(), 150);
}

async function confirmarDerivacion() {
  const destino = document.getElementById('derivar-destino').value.trim();
  if (!destino) {
    showToast('Debe ingresar el ID del operador destino', 'warning');
    return;
  }
  const motivo = document.getElementById('derivar-motivo').value.trim();
  try {
    const data = await apiFetch(`/atencion/api/derivar/${turnoDerivandoId}/`, {
      operador_destino_id: parseInt(destino),
      motivo: motivo || '',
    });
    cerrarModal('modal-derivar');
    showToast(`Turno derivado a ${data.derivado_a}`, 'success');
    setTimeout(() => actualizarPanel(), 800);
  } catch (e) {
    showToast(e.message, 'error');
  }
}

// ── Seleccionar turno de la lista ──
async function seleccionarTurno(turnoId) {
  const ok = await customConfirm(
    'Llamar turno',
    '¿Desea llamar a este turno?',
    { icon: 'fa-bell', iconClass: 'modal-icon-success', btnText: 'Sí, llamar', btnColor: 'rgba(33,150,243,0.95)' }
  );
  if (!ok) return;
  try {
    const data = await apiFetch(`/atencion/api/llamar/${turnoId}/`);
    showToast(`Llamando a ${data.persona} — ${data.mesa}`, 'success');
    setTimeout(() => actualizarPanel(), 1000);
  } catch (e) {
    showToast(e.message, 'error');
  }
}

// ── Auto-actualización sin parpadeo ──
let refreshInterval = null;

async function actualizarPanel() {
  try {
    const response = await fetch(window.location.href, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    const html = await response.text();
    const parser = new DOMParser();
    const newDoc = parser.parseFromString(html, 'text/html');
    
    // Actualizar secciones solo si hay cambios
    actualizarSiDifiere('turno-actual-section', newDoc);
    actualizarSiDifiere('turnos-pendientes', newDoc);
  } catch (e) {
    console.error('Error actualizando panel:', e);
  }
}

function actualizarSiDifiere(sectionId, newDoc) {
  const current = document.getElementById(sectionId);
  const nuevo = newDoc.getElementById(sectionId);
  
  if (!current || !nuevo) return;
  
  // Solo actualizar si el contenido cambió
  if (current.innerHTML.trim() !== nuevo.innerHTML.trim()) {
    current.style.transition = 'opacity 0.2s';
    current.style.opacity = '0.7';
    setTimeout(() => {
      current.innerHTML = nuevo.innerHTML;
      current.style.opacity = '1';
    }, 100);
  }
}

// Iniciar polling inteligente
refreshInterval = setInterval(actualizarPanel, 5000);

// Pausar polling cuando la pestaña está oculta (optimización)
if (document.hidden !== undefined) {
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      clearInterval(refreshInterval);
    } else {
      refreshInterval = setInterval(actualizarPanel, 5000);
      actualizarPanel(); // Actualizar inmediatamente al volver
    }
  });
}
</script>

{% endblock %}
